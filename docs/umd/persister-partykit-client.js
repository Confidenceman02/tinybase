var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,a=e(""),s=(t,e)=>t instanceof e,o=t=>null==t,n=t=>e(t)==a,r=Object,i=r.keys,c=r.freeze,d=t=>(t=>s(t,r)&&t.constructor==r)(t)&&0==(t=>i(t).length)(t),y=t=>JSON.stringify(t,((t,e)=>s(e,Map)?r.fromEntries([...e]):e)),u=JSON.parse,h=t=>new Map(t),l=(t,e)=>t?.get(e),f=(t,e,a)=>{return o(a)?(s=t,n=e,s?.delete(n),t):t?.set(e,a);var s,n},p=(t,e,a)=>{var s,o;return s=t,o=e,s?.has(o)||f(t,e,a()),l(t,e)},v=h(),w=h(),g="message",m={storeProtocol:"https",storePath:"/store"};t.createPartyKitPersister=(t,e,a,s)=>{const{host:r,room:i}=e.partySocketOptions,{storeProtocol:h,storePath:P}={...m,...n(a)?{storeProtocol:a}:a},S=h+"://"+r+"/parties/"+(e.name??"main")+"/"+i+P,A=async t=>await(await fetch(S,{...t?{method:"PUT",body:y(t)}:{},mode:"cors",cache:"no-store"})).json();return((t,e,a,s,n,r,i=[])=>{let y,u,h,g=0,m=0;p(v,i,(()=>0)),p(w,i,(()=>[]));const P=async t=>(2!=g&&(g=1,await S.schedule((async()=>{await t(),g=0}))),S),S={load:async(a,s)=>await P((async()=>{try{t.setContent(await e())}catch{t.setContent([a,s])}})),startAutoLoad:async(a={},o={})=>(S.stopAutoLoad(),await S.load(a,o),m=1,h=s((async(a,s)=>{if(s){const e=s();await P((async()=>t.setTransactionChanges(e)))}else await P((async()=>{try{t.setContent(a?.()??await e())}catch(t){r?.(t)}}))})),S),stopAutoLoad:()=>(m&&(n(h),h=void 0,m=0),S),save:async e=>(1!=g&&(g=2,await S.schedule((async()=>{try{await a(t.getContent,e)}catch(t){r?.(t)}g=0}))),S),startAutoSave:async()=>(await S.stopAutoSave().save(),y=t.addDidFinishTransactionListener(((t,e)=>{const[a,s]=e();d(a)&&d(s)||S.save((()=>[a,s]))})),S),stopAutoSave:()=>{var e,a;return e=y,a=t.delListener,o(e)||a(e),S},schedule:async(...t)=>(((t,...e)=>{t.push(...e)})(l(w,i),...t),await(async()=>{if(!l(v,i)){for(f(v,i,1);!o((t=l(w,i),u=t.shift()));)try{await u()}catch(t){r?.(t)}f(v,i,0)}var t})(),S),getStore:()=>t,destroy:()=>S.stopAutoLoad().stopAutoSave(),getStats:()=>({})};return c(S)})(t,(async()=>await A()),(async(t,a)=>{var s;a?e.send((s=a(),"s"+(n(s)?s:y(s)))):await A(t())}),(t=>{const a=e=>{const[a,s]=[(i=e.data)[0],u((o=i,n=1,o.slice(n,r)))];var o,n,r,i;"s"==a&&t(void 0,(()=>s))};return e.addEventListener(g,a),a}),(t=>{e.removeEventListener(g,t)}),s)}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitClient={});
