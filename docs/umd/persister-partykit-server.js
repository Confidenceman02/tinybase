var e,t;e=this,t=function(e){"use strict";const t=e=>typeof e,a="",s=t(a),n="t",r=(e,t)=>e.startsWith(t),i=Promise,o=e=>null==e,c=(e,t,a)=>o(e)?a?.():t(e),l=(e,t,a)=>e.slice(t,a),u=e=>e.length,f=(e,t)=>e.map(t),h=(e,...t)=>e.push(...t),y=Object,p=(e=[])=>y.fromEntries(e),g=(e,t)=>f(y.entries(e),(([e,a])=>t(a,e))),d=(e,t,a)=>(((e,t)=>!o(((e,t)=>c(e,(e=>e[t])))(e,t)))(e,t)||(e[t]=a()),e[t]),w=e=>JSON.stringify(e,((e,t)=>t instanceof Map?y.fromEntries([...t]):t)),S=JSON.parse,P=(e,a,n)=>e+a+(t(n)==s?n:w(n)),b=(e,t,a)=>{const s=u(e);return r(t,e)?[t[s],(a?S:String)(l(t,s+1))]:void 0},m=(e,t)=>((e,t)=>e?.forEach(t))(e,((e,a)=>t(a,e))),T="hasStore",v=p(f(["Origin","Methods","Headers"],(e=>["Access-Control-Allow-"+e,"*"]))),x=async e=>await e.party.storage.get((e.config.storagePrefix??a)+T),D=async(e,t,s,c)=>{const l=e.party.storage,f=e.config.storagePrefix??a,y=[l.put(f+T,1)],p=[];g(t[0],((t,a)=>o(t)?!s&&e.canDelTable(a,c)&&((e,...t)=>e.unshift(...t))(p,R(f,n,a)):e.canSetTable(a,s,c)&&g(t,((t,r)=>o(t)?!s&&e.canDelRow(a,r,c)&&h(p,R(f,n,a,r)):e.canSetRow(a,r,s,c)&&g(t,((t,i)=>o(t)?!s&&e.canDelCell(a,r,i,c)&&h(y,l.delete(R(f,n,a,r,i))):e.canSetCell(a,r,i,t,s,c)&&h(y,l.put(R(f,n,a,r,i),t)))))))),g(t[1],((t,a)=>o(t)?!s&&e.canDelValue(a,c)&&h(y,l.delete(f+"v"+a)):e.canSetValue(a,t,s,c)&&h(y,l.put(f+"v"+a,t)))),0!=u(p)&&m(await l.list(),(e=>p.every((t=>!r(e,t)||h(y,l.delete(e))&&0)))),await(async e=>i.all(e))(y)},R=(e,t,...a)=>P(e,t,l(w(a),1,-1)),C=async(e,t,a=null)=>new Response(a,{status:t,headers:e.config.responseHeaders??v});e.TinyBasePartyKitServer=class{constructor(e){this.party=e,this.config={}}async onRequest(e){const t=this.config.storePath??"/store";if(new URL(e.url).pathname.endsWith(t)){const t=await x(this),s=await e.text();return"PUT"==e.method?t?C(this,205):(await D(this,S(s),!0,e),C(this,201)):C(this,200,t?w(await(async e=>{const t={},s={},r=e.config.storagePrefix??a;return m(await e.party.storage.list(),((e,a)=>c(b(r,e),(([e,r])=>{if(e==n){const[e,s,n]=S("["+r+"]");d(d(t,e,p),s,p)[n]=a}else"v"==e&&(s[r]=a)})))),[t,s]})(this)):a)}return C(this,404)}async onMessage(e,t){const s=this.config.messagePrefix??a;await c(b(s,e,1),(async([e,a])=>{"s"==e&&await x(this)&&(await D(this,a,!1,t),this.party.broadcast(P(s,"s",a)))}))}canSetTable(e,t,a){return!0}canDelTable(e,t){return!0}canSetRow(e,t,a,s){return!0}canDelRow(e,t,a){return!0}canSetCell(e,t,a,s,n,r){return!0}canDelCell(e,t,a,s){return!0}canSetValue(e,t,a,s){return!0}canDelValue(e,t){return!0}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TinyBasePersisterPartyKitServer={});
