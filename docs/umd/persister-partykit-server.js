var t,e;t=this,e=function(t){"use strict";const e=t=>typeof t,s=e(""),a="t",i=Promise,n=t=>null==t,r=(t,e,s)=>t.slice(e,s),o=t=>t.length,c=(t,e)=>t.map(e),h=(t,...e)=>t.push(...e),f=Object,p=(t=[])=>f.fromEntries(t),l=(t,e)=>c(f.entries(t),(([t,s])=>e(s,t))),y=(t,e,s)=>(((t,e)=>!n(((t,e)=>{return a=t=>t[e],n(s=t)?void 0:a(s);var s,a})(t,e)))(t,e)||(t[e]=s()),t[e]),u=t=>JSON.stringify(t,((t,e)=>e instanceof Map?f.fromEntries([...e]):e)),d=JSON.parse,g=(t,e)=>[t[0],e?d(r(t,1)):r(t,1)],w=(t,e)=>((t,e)=>t?.forEach(e))(t,((t,s)=>e(s,t))),m="hasStore",v=p(c(["Origin","Methods","Headers"],(t=>["Access-Control-Allow-"+t,"*"]))),P=async(t,e)=>await t.get(e+m),R=async(t,e,s)=>{const r=[t.put(e+m,1)],c=[];l(s[0],((s,i)=>n(s)?((t,...e)=>t.unshift(...e))(c,e+x(a,i)):l(s,((s,o)=>n(s)?h(c,e+x(a,i,o)):l(s,((s,n)=>b(r,t,e+x(a,i,o,n),s))))))),l(s[1],((s,a)=>b(r,t,e+"v"+a,s))),0!=o(c)&&w(await t.list(),(e=>c.every((s=>!e.startsWith(s)||b(r,t,e)&&!1)))),await(async t=>i.all(t))(r)},x=(t,...e)=>t+r(u(e),1,-1),b=(t,e,s,a)=>h(t,n(a)?e.delete(s):e.put(s,a));t.TinyBasePartyKitServer=class{constructor(t){this.party=t,this.config={},this.createResponse=(t,e=null)=>new Response(e,{status:t,headers:this.config.responseHeaders??v})}async onRequest(t){const e=this.party.storage,s=this.config.storagePrefix??"",i=this.config.storePath??"/store";if(new URL(t.url).pathname.endsWith(i)){const i=await P(e,s),n=await t.text();return"PUT"==t.method?i?this.createResponse(205):(await R(e,s,d(n)),this.createResponse(201)):this.createResponse(200,i?u(await(async(t,e)=>{const s={},i={};return w(await t.list(),((t,n)=>{if(t.startsWith(e)){t=r(t,o(e));const[c,h]=g(t);if(c==a){const[t,e,a]=d("["+h+"]");y(y(s,t,p),e,p)[a]=n}else"v"==c&&(i[h]=n)}})),[s,i]})(e,s)):"")}return this.createResponse(404)}async onMessage(t,a){const i=this.party.storage,n=this.config.storagePrefix??"",[r,o]=g(t,1);"s"==r&&await P(i,n)&&(await R(i,n,o),this.party.broadcast(((t,a)=>"s"+(e(a)==s?a:u(a)))(0,o),[a.id]))}}},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TinyBasePersisterPartyKitServer={});
